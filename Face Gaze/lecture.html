<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Dashboard - Auto Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        #video-container {
            position: relative;
            width: 100%;
            height: auto;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #2c3e50;
        }
        #video, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #video {
            transform: scaleX(-1); /* Mirror the video */
        }
        #photo-canvas {
            display: none; /* Hidden canvas for capturing the final image */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-8">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4">
            <h1 class="text-3xl font-bold text-blue-700">Lecture Dashboard</h1>
            <button id="logout-btn" class="text-red-500 hover:text-red-700 font-medium mt-2 sm:mt-0">
                <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </button>
        </header>

        <section id="lecture-info" class="bg-blue-50 p-4 rounded-lg">
            <h2 class="text-xl font-semibold text-blue-800">Welcome, <span id="lecture-name" class="font-bold">...</span></h2>
            <p class="text-gray-600">Lecturer ID: <span id="lecture-email" class="font-mono bg-blue-100 px-2 py-0.5 rounded">...</span></p>
            <p class="text-gray-600">Managing Course: <span id="course-id" class="font-mono bg-blue-100 px-2 py-0.5 rounded">...</span></p>
        </section>

        <div class="grid lg:grid-cols-3 gap-8">
            
            <section class="lg:col-span-1">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2 text-purple-700">Live Attendance Check-in</h2>
                <div id="check-in-messages" class="p-3 text-sm text-center rounded-lg bg-yellow-100 text-yellow-700 mb-4">
                    Loading models...
                </div>
                
                <div id="video-container" class="aspect-video mb-4 flex items-center justify-center">
                    <video id="video" autoplay muted></video>
                    <canvas id="canvas"></canvas>
                    <div id="camera-status" class="absolute text-gray-200 font-medium p-4 z-10">Initializing...</div>
                </div>

                <button id="camera-button" class="w-full px-6 py-3 rounded-lg bg-purple-600 text-white font-semibold shadow-md hover:bg-purple-700 transition duration-300">
                    <i class="fas fa-video mr-2"></i> Start Auto Check-in
                </button>
            </section>

            <section class="lg:col-span-1">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2 text-blue-700">Student Enrollment</h2>
                <div id="student-message" class="hidden p-3 text-sm text-center rounded-lg"></div>

                <div class="flex space-x-2 mb-4">
                    <input id="new-student-id" type="text" placeholder="Student ID" class="flex-grow p-2 border rounded-lg">
                    <button id="add-student-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add student</button>
                </div>
                
                <ul id="student-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <li class="text-gray-500 italic">Load student data after logging in.</li>
                </ul>
            </section>

            <section class="lg:col-span-1">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2 text-green-700">Class Attendance</h2>
                <ul id="attendance-view" class="space-y-2 max-h-96 overflow-y-auto">
                    <li class="text-gray-500 italic">No attendance records loaded.</li>
                </ul>
            </section>

        </div>
        
        <canvas id="photo-canvas"></canvas>
        <div id="picture-preview-section" class="hidden">
            <img id="captured-image" class="w-full max-w-xs mx-auto rounded-lg shadow-lg" alt="Captured Picture">
        </div>
    </div>

    <script>
        const logoutBtn = document.getElementById('logout-btn');
        const lectureNameSpan = document.getElementById('lecture-name');
        const lectureEmailSpan = document.getElementById('lecture-email'); // NEW
        const courseIdSpan = document.getElementById('course-id');
        const studentList = document.getElementById('student-list');
        const attendanceView = document.getElementById('attendance-view');
        const newStudentIdInput = document.getElementById('new-student-id');
        const addStudentBtn = document.getElementById('add-student-btn');
        const studentMessage = document.getElementById('student-message');
        const checkInMessages = document.getElementById('check-in-messages');
        const cameraButton = document.getElementById('camera-button');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photoCanvas = document.getElementById('photo-canvas');
        const cameraStatus = document.getElementById('camera-status');
        const capturedImage = document.getElementById('captured-image');
        const picturePreviewSection = document.getElementById('picture-preview-section');
        
        // Face Recognition Variables
        let stream = null;
        let currentDetections = [];
        let capturedImageDataUrl = null;
        let faceMatcher = null; 
        let currentLectureId = "LECT101"; // HARDCODED
        let detectionInterval = null; // To control the detection loop

        // --- MANUAL DATA MANAGEMENT ---
        // Load or initialize mock data from localStorage
        let enrolledStudents = JSON.parse(localStorage.getItem('enrolledStudents')) || [
            'S1001_Alice', 'S1002_Bob', 'S1003_Charlie'
        ];
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];

        function saveStudentData() {
            localStorage.setItem('enrolledStudents', JSON.stringify(enrolledStudents));
        }

        function saveAttendanceData() {
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
        }

        function showStudentMessage(text, type = 'success') {
            studentMessage.textContent = text;
            studentMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'success') {
                studentMessage.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                studentMessage.classList.add('bg-red-100', 'text-red-700');
            }
            setTimeout(() => {
                studentMessage.classList.add('hidden');
            }, 3000);
        }

        // --- UTILITY FUNCTIONS ---

        function showMessage(text, type = 'success') {
            checkInMessages.textContent = text;
            checkInMessages.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'success') {
                checkInMessages.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                checkInMessages.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'warning') {
                checkInMessages.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            // Message stays longer for the lecturer dashboard
            setTimeout(() => {
                checkInMessages.textContent = "Ready for face check-in.";
                checkInMessages.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                checkInMessages.classList.add('bg-yellow-100', 'text-yellow-700');
            }, 8000);
        }

        // --- DASHBOARD RENDERING FUNCTIONS ---
        
        function renderStudents(students) {
            studentList.innerHTML = '';
            if (students.length === 0) {
                studentList.innerHTML = '<li class="text-gray-500 italic">No students enrolled yet.</li>';
                return;
            }
            students.forEach(studentId => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm';
                const displayId = studentId.split('_')[0];
                li.innerHTML = `
                    <span class="font-medium">${displayId}</span>
                    <button data-id="${studentId}" class="remove-student-btn text-red-500 hover:text-red-700 text-sm">Remove</button>
                `;
                studentList.appendChild(li);
            });
            document.querySelectorAll('.remove-student-btn').forEach(btn => {
                btn.addEventListener('click', removeStudent);
            });
        }

        function renderAttendance(attendance) {
            attendanceView.innerHTML = '';
            if (attendance.length === 0) {
                attendanceView.innerHTML = '<li class="text-gray-500 italic">No attendance recorded yet.</li>';
                return;
            }
            
            // Only show attendance records related to this mock lecture
            const lectureAttendance = attendance.filter(record => record.lectureId === currentLectureId);
            
            lectureAttendance.forEach(record => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-green-50 rounded-lg border-l-4 border-green-500';
                const displayId = record.studentId.split('_')[0];
                li.innerHTML = `
                    <p class="font-medium">${displayId}</p>
                    <p class="text-sm text-gray-600">${record.date} at ${record.time}</p>
                `;
                attendanceView.appendChild(li);
            });
        }
        
        // --- FACE RECOGNITION CORE FUNCTIONS ---
        // Simplified loadLabeledImages to use the locally managed enrolledStudents
        async function loadLabeledImages(studentList) {
            const labels = studentList; 
            
            return Promise.all(
                labels.map(async label => {
                    // MOCK DATA CREATION: Generate a unique random descriptor for each student
                    const seed = label.split('_')[0].charCodeAt(0) * 100 + label.split('_')[0].charCodeAt(1);
                    const descriptor = new Float32Array(128).map((_, i) => (Math.sin(i + seed) + 1) / 2);
                    
                    return new faceapi.LabeledFaceDescriptors(label, [descriptor]);
                })
            );
        }

        async function initFaceRecognition(studentList) {
            showMessage("Loading Face Recognition Models...", 'warning');
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights')
            ]);
            
            showMessage(`Models loaded. Loading data for ${studentList.length} students...`, 'warning');
            const labeledDescriptors = await loadLabeledImages(studentList);
            faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6); // 0.6 is the tolerance
            
            cameraStatus.textContent = `Recognition ready for ${studentList.length} students.`;
            showMessage("System ready. Click Start Auto Check-in.", 'success');
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                stream = null;
            }
            if (detectionInterval) {
                clearInterval(detectionInterval);
            }
            cameraButton.innerHTML = '<i class="fas fa-video mr-2"></i> Start Auto Check-in';
            cameraButton.disabled = false;
            cameraStatus.classList.remove('hidden');
            cameraStatus.textContent = "Camera stopped.";
            showMessage("Check-in system disabled.", 'warning');
        }

        function takePicture(detections) {
            if (!stream || video.paused || video.ended) return;

            const displaySize = { width: video.videoWidth, height: video.videoHeight };

            photoCanvas.width = displaySize.width;
            photoCanvas.height = displaySize.height;
            const context = photoCanvas.getContext('2d');

            context.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);
            faceapi.matchDimensions(photoCanvas, displaySize);
            faceapi.draw.drawDetections(photoCanvas, detections);

            capturedImageDataUrl = photoCanvas.toDataURL('image/png');
            capturedImage.src = capturedImageDataUrl;
            picturePreviewSection.classList.remove('hidden');
        }
        
        // --- MANUAL CHECK-IN LOGIC ---

        async function processCheckIn(studentId) {
            
            // 1. Check for duplicate attendance today (Manual Check)
            const today = new Date().toISOString().substring(0, 10);
            const alreadyCheckedIn = attendanceRecords.some(record => 
                record.studentId === studentId && record.lectureId === currentLectureId && record.lectureDate === today
            );
            
            if (alreadyCheckedIn) {
                return showMessage(`Student ${studentId.split('_')[0]} already checked in today.`, 'warning');
            }
            
            // 2. Mock Attendance Recording (Geolocation is omitted as per manual requirement)
            const newRecord = {
                studentId: studentId,
                lectureId: currentLectureId,
                lectureDate: today,
                checkInTime: new Date().toLocaleTimeString(),
                imageDataUrl: capturedImageDataUrl,
                latitude: 'MOCK_LAT', // Mock data
                longitude: 'MOCK_LON' // Mock data
            };
            
            attendanceRecords.push(newRecord);
            saveAttendanceData();
            
            // 3. Refresh display
            renderAttendance(attendanceRecords); 
            showMessage(`Check-in successful for ${studentId.split('_')[0]}!`, 'success');
        }


        async function startCamera() {
            if (!faceMatcher) {
                return showMessage("Face recognition system not initialized. Please refresh.", 'error');
            }
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                cameraButton.innerHTML = '<i class="fas fa-times-circle mr-2"></i> Stop Check-in';
                cameraButton.disabled = true; // Disabled briefly during detection setup
                
                cameraStatus.textContent = "Checking for face...";
                cameraStatus.classList.remove('hidden');

                video.addEventListener('loadedmetadata', () => {
                    const displaySize = { width: video.videoWidth, height: video.videoHeight };
                    faceapi.matchDimensions(canvas, displaySize);
                    cameraButton.disabled = false;
                    
                    detectionInterval = setInterval(async () => {
                        const fullFaceDescriptions = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                            .withFaceLandmarks()
                            .withFaceDescriptors();

                        currentDetections = faceapi.resizeResults(fullFaceDescriptions, displaySize);
                        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                        
                        let identified = false;

                        if (currentDetections.length > 0) {
                            currentDetections.forEach(detection => {
                                const result = faceMatcher.findBestMatch(detection.descriptor);
                                const box = detection.detection.box;
                                const drawBox = new faceapi.draw.DrawBox(box, { label: result.toString() });
                                drawBox.draw(canvas);

                                if (!identified && result.label !== 'unknown') {
                                    identified = true;
                                    const studentId = result.label; // Use the full label (e.g., S1001_Alice)
                                    
                                    takePicture(currentDetections);
                                    clearInterval(detectionInterval); 
                                    stopCamera(); 
                                    
                                    processCheckIn(studentId);
                                }
                            });

                            if (currentDetections.length === 1 && !identified) {
                                showMessage("Face detected, but student is UNKNOWN. Enrollment required.", 'warning');
                            } else if (currentDetections.length > 1) {
                                showMessage(`Multiple faces detected. Please ensure only one person is in view.`, 'warning');
                            }
                        } else {
                            cameraStatus.textContent = "Checking for face...";
                        }
                    }, 1500);

                }, { once: true });
            } catch (err) {
                console.error("Error accessing the camera:", err);
                cameraStatus.textContent = "Error: Camera access denied or not available.";
                showMessage("Error accessing the camera. Check permissions.", "error");
            }
        }
        
        // --- MANUAL DASHBOARD DATA SETUP ---

        function setupManualDashboard(initRecog = true) {
            // Get credentials from sessionStorage set during login
            const lecturerEmail = sessionStorage.getItem('lecturerEmail') || 'ntuthukolwandisa@gmail.com';
            const lecturerName = sessionStorage.getItem('lecturerName') || 'Ntuthuko Lwandisa';

            if (!lecturerEmail) {
                // If there's no email, the user didn't log in - redirect
                window.location.href = 'index.html'; 
                return;
            }
            
            // Manually populate lecturer info
            lectureNameSpan.textContent = lecturerName;
            lectureEmailSpan.textContent = lecturerEmail; // Populated with the user's ID (email)
            courseIdSpan.textContent = currentLectureId;
            
            renderStudents(enrolledStudents);
            renderAttendance(attendanceRecords);
            
            if (initRecog) {
                initFaceRecognition(enrolledStudents);
            }
        }

        async function addStudent() {
            const studentId = newStudentIdInput.value.trim();
            if (!studentId) return showStudentMessage('Please enter a student ID.', 'error');
            
            // Ensure ID is unique
            const existingStudent = enrolledStudents.find(s => s.startsWith(studentId.split('_')[0]));
            if (existingStudent) {
                 return showStudentMessage('Student ID already exists.', 'error');
            }

            // NOTE: The ID should ideally include the name part (e.g., S1004_Name) for face-api.js
            const studentIdForRecog = studentId.includes('_') ? studentId : studentId + "_NewStudent";
            
            enrolledStudents.push(studentIdForRecog);
            saveStudentData();

            showStudentMessage('Student added. Refreshing recognition data...', 'success');
            newStudentIdInput.value = '';
            renderStudents(enrolledStudents);
            await initFaceRecognition(enrolledStudents); // Re-initialize recognition with new student
        }

        async function removeStudent(e) {
            const studentIdToRemove = e.target.dataset.id;
            if (!confirm(`Are you sure you want to remove student ${studentIdToRemove.split('_')[0]}?`)) return;

            // Remove from local array
            enrolledStudents = enrolledStudents.filter(s => s !== studentIdToRemove);
            saveStudentData();

            showStudentMessage('Student removed. Refreshing recognition data...', 'success');
            renderStudents(enrolledStudents);
            await initFaceRecognition(enrolledStudents); // Re-initialize recognition
        }

        async function logout() {
            stopCamera();
            sessionStorage.removeItem('lecturerEmail'); // Clear session
            sessionStorage.removeItem('lecturerName'); // Clear session
            window.location.href = 'index.html';
        }

        // --- EVENT LISTENERS AND INITIALIZATION ---
        addStudentBtn.addEventListener('click', addStudent);
        logoutBtn.addEventListener('click', logout);
        cameraButton.addEventListener('click', () => {
            if (stream) {
                stopCamera();
            } else {
                startCamera();
            }
        });
        
        setupManualDashboard(); // Changed from fetchLectureData()
    </script>
</body>
</html>